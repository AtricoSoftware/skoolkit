SKOOLFILES=${SKOOLFILES:-$GAMEDIR.skool}
DIFFSBUILD=$DHOME/build/disassembly-diff

BUILD=$DHOME/build
DIST=$DHOME/dist
DTMPDIR=$HOME/tmp
REFFILE=$DHOME/sources/$GAMEDIR.ref
[[ -f $REFFILE ]] || REFFILE=$DHOME/sources/$GAME.ref
VERSION=$(grep ^Release= $REFFILE | awk '{print $NF}')
RELEASE=$GAME-disassembly-$VERSION
SKOOLKIT_TOOLS=$SKOOLKIT_HOME/tools
SKOOLKIT_VERSION=$(cd $SKOOLKIT_HOME; git tag | tail -n 1 | cut -c2-)

###############################################################################
# Check required environment variables
###############################################################################
_require_skoolkit_archive() {
  if [[ -z $SKOOLKIT_ARCHIVE ]]; then
    echo 'SKOOLKIT_ARCHIVE is not set; aborting'
    exit 1
  fi
  if [[ ! -d $SKOOLKIT_ARCHIVE ]]; then
    echo "SKOOLKIT_ARCHIVE=$SKOOLKIT_ARCHIVE: directory not found"
    exit 1
  fi
  SKOOLKIT_TARBALL=$SKOOLKIT_ARCHIVE/skoolkit-$SKOOLKIT_VERSION.tar.xz
}

###############################################################################
# Utility functions
###############################################################################
_exec() {
  message=$1
  command=$2
  logfile=$3
  failcode=$4

  echo -n "${message}: "
  if ! eval $command &> $logfile; then
    if [[ -z "$failcode" ]] || [[ $? -eq "$failcode" ]]; then
      echo "FAILED (see $logfile)"
      return 1
    fi
  fi
  echo "OK"
}

_cd_tmpdir() {
  mkdir -p $DTMPDIR
  cd $(mktemp -d --tmpdir=$DTMPDIR)
}

_check_files() {
  filetype=$1
  expdir=$2
  logdir=$3
  shift 3
  expfiles=$*

  echo -n "Checking $filetype: "
  if [[ ! -d $expdir ]]; then
    echo "FAILED ($expdir does not exist)"
    return 1
  fi

  prefix=$(echo $filetype | tr ' ' _)
  elist=$logdir/$prefix-expected.txt
  for f in $expfiles; do echo $f; done | sort > $elist
  alist=$logdir/$prefix-actual.txt
  ls -A1 $expdir | grep -Ev "^(html|sources)$" | sort > $alist

  missing=$logdir/$prefix-missing.txt
  comm -23 $elist $alist > $missing
  if [[ -s $missing ]]; then
    echo "FAILED (expected files missing; see $missing)"
    return 1
  fi

  extra=$logdir/$prefix-extra.txt
  comm -13 $elist $alist > $extra
  if [[ -s $extra ]]; then
    echo "FAILED (unexpected files found; see $extra)"
    return 1
  fi

  echo "OK"
}

###############################################################################
# Count lines of length 80 or more in the skool files
###############################################################################
count_lines() {
  _cd_tmpdir
  for skoolfile in $SKOOLFILES; do
    cmd="$SKOOLKIT_TOOLS/count80.py -i $DHOME/sources/.clinesignore -p $DHOME/sources/$skoolfile"
    _exec "Counting lines of length 80 or more in $skoolfile" "$cmd" $(pwd)/$skoolfile.log
  done
}

###############################################################################
# Run disassembly-diff on the disassembly
###############################################################################
disassembly_diffs() {
  mkdir -p $DIFFSBUILD
  cd $DIFFSBUILD
  $SKOOLKIT_TOOLS/disassembly-diff -c $SKOOLKIT_VERSION $* $GAME 2>&1 | tee diffs.log
}

###############################################################################
# Run check-asms on the disassembly
###############################################################################
check_asms() {
  cd $DIFFSBUILD/disassembly-current-$SKOOLKIT_VERSION/asm
  $SKOOLKIT_TOOLS/check-asms $GAME 2>&1 | tee ../check-asms.log
}

###############################################################################
# Make a TAP file from an ASM file and load it
###############################################################################
check_tap() {
  _require_skoolkit_archive

  binfile=$DIFFSBUILD/disassembly-current-$SKOOLKIT_VERSION/asm/$1.bin
  tapfile=$(basename $binfile .bin).tap
  _cd_tmpdir
  tar xf $SKOOLKIT_TARBALL
  _exec "Writing $tapfile" "skoolkit-$SKOOLKIT_VERSION/bin2tap.py -t $tapfile $binfile" $(pwd)/bin2tap.log
  fuse $tapfile
}

###############################################################################
# Run skooldiff on the disassembly
###############################################################################
skooldiff() {
  _cd_tmpdir
  _exec "Running skooldiff" "$SKOOLKIT_TOOLS/skooldiff $GAME" $(pwd)/skooldiff.log
}

###############################################################################
# Build the disassembly distribution tarball and zip archive
###############################################################################
build_tarball() {
  _require_skoolkit_archive

  _cd_tmpdir
  logdir=$(pwd)
  tar xf $SKOOLKIT_TARBALL
  cd skoolkit-$SKOOLKIT_VERSION
  _exec "Building tarball and zip archive" "$SKOOLKIT_TOOLS/mkdtarball $DHOME $GAME" $logdir/build.log
  root=dist/$RELEASE
  _exec "Checking links" "$SKOOLKIT_TOOLS/check-links.py $root/html" $logdir/check-links.log
  _check_files "source files" $root/sources $logdir $SRCFILES
  _check_files "txt files" $root $logdir asm.txt readme.txt
  _exec "Checking lines in asm.txt" "$SKOOLKIT_TOOLS/count80.py -p $root/asm.txt" $logdir/count80-asm.txt
  _exec "Checking lines in readme.txt" "$SKOOLKIT_TOOLS/count80.py -p $root/readme.txt" $logdir/count80-readme.txt
  less $root/asm.txt
  less $root/readme.txt
  mkdir -p $DIST
  mv $root.{tar.xz,zip} $DIST
}

###############################################################################
# Update the HTML disassembly on the gh-pages branch
###############################################################################
update_ghpages() {
  _require_skoolkit_archive

  mkdir -p $BUILD
  htmldir=$BUILD/html/$GAMEDIR
  rm -rf $htmldir
  tar xf $SKOOLKIT_TARBALL -C $BUILD
  _exec "Building disassembly" "make -C $DHOME $GAME SKOOLKIT_HOME=$BUILD/skoolkit-$SKOOLKIT_VERSION HTML_OPTS='$GHHTMLOPTS'" $BUILD/$GAME-build.log

  _cd_tmpdir
  echo -n "Cloning $GHREPO repository: "
  git clone -q https://github.com/skoolkid/$GHREPO
  echo "OK"
  cd $GHREPO
  git checkout -q gh-pages
  rsync -r $htmldir/ .
  echo
  git status -bs
  cat <<EOM

Now:
  \$ cd $(pwd)
  # Remove any files that are no longer used
  # Add any new files
  \$ git commit -am "Update $GAMENAME disassembly to $VERSION"
  \$ git push origin gh-pages
EOM
}

###############################################################################
# Run the disassembly tests
###############################################################################
test_disassembly() {
  _require_skoolkit_archive

  _cd_tmpdir
  logdir=$(pwd)
  tar xf $SKOOLKIT_TARBALL
  cd skoolkit-$SKOOLKIT_VERSION
  for v in 2.7 3.2 3.3 3.4; do
    _exec "Running $GAMENAME disassembly tests (SkoolKit $SKOOLKIT_VERSION, Python $v)" "SKOOLKIT_HOME=$(pwd) make -C $DHOME test$v" $logdir/test$v.log
  done
}

###############################################################################
# Print usage information
###############################################################################
usage() {
  cat >&2 <<EOM
Usage: $(basename $0) COMMAND [COMMAND...]

$GAMENAME disassembly testing and release tool.

Commands:
  clines - count lines of length 80 or more in the skool file(s)
  ddiffs - run disassembly-diff on the disassembly
  ddiffn - run 'disassembly-diff -n' on the disassembly
  asmchk - run check-asms on the disassembly
  mktap1 - make a TAP file from the base ASM file and load it
  mktap2 - make a TAP file from the base @rsub-mode ASM file and load it
  skoold - run skooldiff on the disassembly
  dtests - run the disassembly tests
  tarzip - build the disassembly distribution tarball and zip archive
  ghhtml - update the HTML disassembly on the gh-pages branch
EOM
  exit 1
}

###############################################################################
# Parse command line
###############################################################################
parse_args() {
  numcommands=$#
  (($numcommands < 1)) && usage

  while [[ -n "$1" ]]; do
    [[ $numcommands -ge 2 ]] && echo "*** Running command '$1' ***"
    case "$1" in
      clines) count_lines ;;
      ddiffs) disassembly_diffs ;;
      ddiffn) disassembly_diffs -n ;;
      asmchk) check_asms ;;
      mktap1) check_tap $GAME ;;
      mktap2) check_tap $GAME-f1-r ;;
      skoold) skooldiff ;;
      dtests) test_disassembly ;;
      tarzip) build_tarball ;;
      ghhtml) update_ghpages ;;
           *) echo "*** Unknown command '$1' ***"; usage ;;
    esac
    shift
  done
}
