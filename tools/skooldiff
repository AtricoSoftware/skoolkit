#!/usr/bin/env bash
set -e # Abort on errors

. $(dirname $0)/ddiffs-functions

usage() {
  cat <<EOF
Usage: $(basename $0) [-c] $GAMES

  Compares the original skool file for a game with one generated from a skool
  file template (or control file if -c is used) and a snapshot.
EOF
  exit 1
}

if [ -z "$SKOOLKIT_HOME" ]; then
  echo "Error: SKOOLKIT_HOME not defined."
  exit 1
fi
if [ ! -d "$SKOOLKIT_HOME" ]; then
  echo "Error: directory not found: $SKOOLKIT_HOME"
  exit 1
fi

ctl=0
[[ $1 == -c ]] && ctl=1 && shift

GAME=$1
read_ddiffsrc $GAME

if [ "$GAME" = "rom" ]; then
  SKOOL=$DHOME/sources/rom.skool
  SNA2SKOOL_OPTS="-o 0 -H"
else
  SKOOL=$(ls -1 $DHOME/sources/*.skool | grep -Ev '/(load|save|start).skool')
fi

SKOOL2=$GAME.skool
DIFF=$GAME.diff

if ((ctl == 1)); then
  CTL=$GAME.ctl
  $SKOOLKIT_HOME/skool2ctl.py $SKOOL > $CTL
  $SKOOLKIT_HOME/sna2skool.py $SNA2SKOOL_OPTS -c $CTL $SNAPSHOT > $SKOOL2
else
  SFT=$GAME.sft
  $SKOOLKIT_HOME/skool2sft.py $SKOOL > $SFT
  $SKOOLKIT_HOME/sna2skool.py $SNA2SKOOL_OPTS -T $SFT $SNAPSHOT > $SKOOL2
fi

if colordiff -Bu $SKOOL $SKOOL2; then
  echo "No differences" 1>&2
fi
